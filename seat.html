<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Seat Booking | Kashish Travels</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background:#f5f6f8;
}
.header{
  background:#fff;
  padding:14px;
  text-align:center;
  font-size:20px;
  font-weight:600;
  box-shadow:0 4px 15px rgba(0,0,0,.08);
}
.bus-card{
  max-width:950px;
  margin:25px auto;
  background:#fff;
  border-radius:18px;
  box-shadow:0 25px 60px rgba(0,0,0,.12);
  overflow:hidden;
}
.deck-switch{
  display:flex;
  background:#f1f1f1;
}
.deck-btn{
  flex:1;
  padding:15px;
  text-align:center;
  font-weight:600;
  cursor:pointer;
}
.deck-btn.active{
  background:#fff;
  border-bottom:4px solid #ffc107;
}
.interior{padding:22px;display:none;}
.interior.active{display:block;}

.driver{
  text-align:right;
  font-size:14px;
  color:#777;
  margin-bottom:10px;
}

.layout{
  display:grid;
  grid-template-columns:95px 45px 95px 95px;
  gap:18px;
  justify-content:center;
}

.seat{
  height:95px;
  border-radius:14px;
  background:#eee;
  cursor:pointer;
  position:relative;
}
.seat.booked{
  background:#e57373;
  cursor:not-allowed;
}
.seat.selected{
  background:#66bb6a;
}

.seat span{
  position:absolute;
  bottom:6px;
  right:8px;
  font-size:12px;
  font-weight:600;
}

.seat-price{
  position:absolute;
  top:8px;
  left:8px;
  font-size:12px;
  font-weight:700;
  background:#fff;
  padding:4px 6px;
  border-radius:6px;
}

.book-bar{
  padding:20px;
  border-top:1px solid #ddd;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
}
.book-btn{
  padding:12px 18px;
  font-weight:700;
  background:#ffc107;
  border:none;
  border-radius:10px;
  cursor:pointer;
}

.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.4);
  display:none;
  align-items:center;
  justify-content:center;
}
.modal-box{
  background:#fff;
  width:90%;
  max-width:420px;
  padding:25px;
  border-radius:16px;
}
.modal-box input{
  width:100%;
  padding:14px;
  margin:10px 0;
  border-radius:10px;
  border:1px solid #ccc;
}
.confirm-btn{
  width:100%;
  padding:14px;
  background:#ffc107;
  border:none;
  font-weight:700;
  border-radius:10px;
}
.success{display:none;text-align:center;}
.download{
  margin-top:15px;
  padding:14px;
  width:100%;
  background:#4caf50;
  border:none;
  color:#fff;
  border-radius:10px;
}

@media(max-width:768px){
  .layout{grid-template-columns:1fr 1fr;}
  .book-bar{flex-direction:column;}
}
</style>
</head>

<body>

<div class="header" id="headerBus"></div>

<div class="bus-card">

<div class="deck-switch">
  <div class="deck-btn active" onclick="switchDeck('lower',this)">LOWER</div>
  <div class="deck-btn" onclick="switchDeck('upper',this)">UPPER</div>
</div>

<div id="lower" class="interior active">
  <div class="driver">üßë‚Äç‚úàÔ∏è Driver</div>
  <div class="layout" id="lowerLayout"></div>
</div>

<div id="upper" class="interior">
  <div class="layout" id="upperLayout"></div>
</div>

<div class="book-bar">
  <div id="availableSeats">Available Seats: 36</div>
  <button class="book-btn" onclick="openForm()">Book Seats</button>
  <div id="fare">Total Fare: ‚Çπ0</div>
</div>

</div>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="modal-box">
    <div id="form">
      <h3>Passenger Details</h3>
      <input id="pname" placeholder="Full Name">
      <input id="pmobile" placeholder="Mobile Number" maxlength="10">
      <button class="confirm-btn" onclick="confirmBooking()">Confirm</button>
    </div>

    <div class="success" id="success">
      <h2>Booking Successful üéâ</h2>
      <button class="download" onclick="downloadPDF()">Download Ticket</button>
    </div>
  </div>
</div>

<script>
/* DATA FROM search.html */
const busName = localStorage.getItem("busName");
const route   = localStorage.getItem("route");
const price   = Number(localStorage.getItem("price"));
const date    = localStorage.getItem("busDate");

/* ‚úÖ DATE FORMAT FIX */
function formatDate(inputDate){
  const d = new Date(inputDate);
  const options = { day:'2-digit', month:'short', year:'numeric' };
  return d.toLocaleDateString('en-GB', options);
}

/* HEADER */
document.getElementById("headerBus").innerText =
`${busName} | ${route} | ‚Çπ${price} | ${formatDate(date)}`;

/* UNIQUE BOOKING KEY */
function bookingKey(){
  return busName + "-" + route + "-" + date;
}

/* SEAT PRICE LOGIC */
const seatPrices = {
  "Lower-1":900,"Lower-2":900,"Lower-3":850,
  "Lower-4":800,"Lower-5":800,
  "Upper-19":700,"Upper-20":700,"Upper-21":750
};

const defaultPrice = price;
let selected = [];

function getBooked(){
  return JSON.parse(localStorage.getItem(bookingKey())) || [];
}

function updateAvailable(){
  document.getElementById("availableSeats").innerText =
  "Available Seats: " + (36 - getBooked().length);
}

function generate(layout,start,deck){
  layout.innerHTML="";
  let booked = getBooked();

  for(let i=0;i<18;i++){
    let seat=document.createElement("div");
    let label=`${deck}-${start+i}`;
    let seatPrice = seatPrices[label] || defaultPrice;

    seat.className="seat";
    seat.innerHTML=`
      <div class="seat-price">‚Çπ${seatPrice}</div>
      <span>${label}</span>
    `;

    if(booked.includes(label)){
      seat.classList.add("booked");
    }else{
      seat.onclick=()=>{
        seat.classList.toggle("selected");

        if(seat.classList.contains("selected"))
          selected.push(label);
        else
          selected.splice(selected.indexOf(label),1);

        let total = selected.reduce((sum,s)=>
          sum + (seatPrices[s] || defaultPrice),0);

        document.getElementById("fare").innerText =
        "Total Fare: ‚Çπ"+total;
      }
    }
    layout.appendChild(seat);
  }
  updateAvailable();
}

generate(lowerLayout,1,"Lower");
generate(upperLayout,19,"Upper");

function switchDeck(id,btn){
  document.querySelectorAll(".interior").forEach(i=>i.classList.remove("active"));
  document.querySelectorAll(".deck-btn").forEach(b=>b.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  btn.classList.add("active");
}

function openForm(){
  if(selected.length===0){
    alert("Select seats first");
    return;
  }
  modal.style.display="flex";
}

let receipt={};

function confirmBooking(){
  let n=pname.value.trim();
  let m=pmobile.value.trim();

  if(!n || m.length!==10){
    alert("Invalid details");
    return;
  }

  let booked = getBooked().concat(selected);
  localStorage.setItem(bookingKey(), JSON.stringify(booked));

  let total = selected.reduce((sum,s)=>
    sum + (seatPrices[s] || defaultPrice),0);

  receipt={
    id:"KT"+Date.now(),
    name:n,
    mobile:m,
    seats:selected.join(", "),
    total:total
  };

  form.style.display="none";
  success.style.display="block";
  selected=[];

  generate(lowerLayout,1,"Lower");
  generate(upperLayout,19,"Upper");
}

function downloadPDF(){
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF();

  pdf.text("KASHISH TRAVELS",20,20);
  pdf.text("Booking ID: "+receipt.id,20,30);
  pdf.text("Name: "+receipt.name,20,40);
  pdf.text("Mobile: "+receipt.mobile,20,50);
  pdf.text("Route: "+route,20,60);
  pdf.text("Date: "+formatDate(date),20,70);
  pdf.text("Seats: "+receipt.seats,20,80);
  pdf.text("Total Fare: ‚Çπ"+receipt.total,20,90);

  pdf.save("Ticket.pdf");
}
</script>

</body>
</html>
